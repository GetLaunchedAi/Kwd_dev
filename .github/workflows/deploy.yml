name: Deploy to Cloudways

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Cloudways via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.CLOUDWAYS_HOST }}
          username: ${{ secrets.CLOUDWAYS_USER }}
          key: ${{ secrets.CLOUD_SSH_KEY }}
          # If you prefer password auth (not recommended but supported), uncomment next line and comment out 'key'
          # password: ${{ secrets.CLOUDWAYS_PASS }}
          port: 22
          script: |
            set -e

            APP_DIR="/home/master/applications/qqmunqdbbw/public_html"

            echo "Deploying to $APP_DIR..."

            if [ ! -d "$APP_DIR" ]; then
              echo "Error: Application directory not found at $APP_DIR"
              exit 1
            fi

            cd $APP_DIR

            # Load nvm and switch to a compatible Node version (>=20.19.0)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm install 20 2>/dev/null || true
            nvm use 20
            echo "Using Node $(node -v) / npm $(npm -v)"

            # Configure git pull strategy if not set
            git config pull.rebase false 2>/dev/null || true

            # Pull latest changes (.env files are safe â€” they're in .gitignore)
            git pull origin main

            # Install ALL deps (dev deps needed for build/tsc)
            npm install

            # Build the application
            npm run build

            # Remove dev dependencies for production
            npm prune --omit=dev

            # Restart the application using PM2
            npx pm2 restart kwd-cursor-tool || npx pm2 start ecosystem.config.js

            echo "Deployment complete!"

